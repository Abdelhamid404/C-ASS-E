<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance - NCTU SIS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h3><i class="bi bi-mortarboard-fill"></i> NCTU SIS</h3>
        </div>
        <ul class="nav flex-column sidebar-menu" id="sidebar-menu"></ul>
        <div class="px-3 py-2">
            <button class="btn btn-outline-danger btn-sm w-100" onclick="auth.logout()">
                <i class="bi bi-box-arrow-right me-2"></i>Logout
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="topbar">
            <h4 class="mb-0">Attendance</h4>
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">U</div>
                <div>
                    <div id="user-name">User</div>
                    <small class="text-muted" id="user-role">Role</small>
                </div>
            </div>
        </div>

        <div id="attendance-content"></div>
    </div>

    <div class="modal fade" id="attendanceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Attendance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="attendance-edit-form">
                    <div class="modal-body">
                        <div id="attendance-edit-message"></div>
                        <input type="hidden" id="attendance-edit-id">
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="attendance-edit-status">
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                                <option value="late">Late</option>
                                <option value="excused">Excused</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Remarks</label>
                            <textarea class="form-control" id="attendance-edit-notes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script>
        let role = null;
        const content = document.getElementById('attendance-content');
        const editForm = document.getElementById('attendance-edit-form');
        const editMessage = document.getElementById('attendance-edit-message');
        let attendanceModal;

        function renderAttendanceRecords(attendance, containerId, canEdit) {
            const listDiv = document.getElementById(containerId);
            if (!listDiv) return;

            if (!attendance.length) {
                listDiv.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>No attendance records found.
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = `
                <div class="card">
                    <div class="card-header">Attendance Records</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Student ID</th>
                                        <th>Student Name</th>
                                        <th>Status</th>
                                        <th>Remarks</th>
                                        ${canEdit ? '<th class="text-end">Actions</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${attendance.map(a => `
                                        <tr>
                                            <td>${UIHelper.formatDate(a.date)}</td>
                                            <td>${a.studentId}</td>
                                            <td>${a.studentName}</td>
                                            <td><span class="badge ${UIHelper.getAttendanceBadgeClass(a.status)}">${a.status}</span></td>
                                            <td>${a.notes || '-'}</td>
                                            ${canEdit ? `
                                                <td class="text-end">
                                                    <button class="btn btn-sm btn-outline-secondary me-1" onclick="openAttendanceModal(${a.id}, '${a.status}', ${JSON.stringify(a.notes || '')})">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAttendanceRecord(${a.id})">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            ` : ''}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadAttendance() {
            if (role === 'ROLE_STUDENT') {
                try {
                    const user = auth.getUser();
                    const data = await API.getAttendance(user.studentId);
                    
                    content.innerHTML = `
                        <div class="card">
                            <div class="card-header">My Attendance</div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Course</th>
                                                <th>Status</th>
                                                <th>Remarks</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.attendance.map(a => `
                                                <tr>
                                                    <td>${UIHelper.formatDate(a.sessionDate)}</td>
                                                    <td>${a.courseName}</td>
                                                    <td><span class="badge ${UIHelper.getAttendanceBadgeClass(a.status)}">${a.status}</span></td>
                                                    <td>${a.remarks || '-'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    UIHelper.showError(error.message, content);
                }
            } else if (role === 'ROLE_PROFESSOR') {
                try {
                    const coursesData = await API.getProfessorCourses();
                    const courseOptions = coursesData.courses.map(c => `
                        <option value="${c.courseId}" data-semester="${c.semesterId}">${c.courseCode || c.code} - ${c.courseName || c.nameEn}</option>
                    `).join('');
                    content.innerHTML = `
                        <div class="card mb-4">
                            <div class="card-header">Record Attendance</div>
                            <div class="card-body">
                                <form id="attendance-form">
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Course</label>
                                            <select class="form-select" id="record-course-select" required>
                                                <option value="">Select Course</option>
                                                ${courseOptions}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Session Date</label>
                                            <input type="date" class="form-control" id="record-session-date" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Session Type</label>
                                            <select class="form-select" id="record-session-type" required>
                                                <option value="lecture">Lecture</option>
                                                <option value="lab">Lab</option>
                                                <option value="tutorial">Tutorial</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-primary w-100" onclick="loadStudentsForAttendance()">
                                                Load Students
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div id="students-attendance-list"></div>
                        <div class="card mt-4">
                            <div class="card-header">Review Attendance</div>
                            <div class="card-body">
                                <form id="attendance-view-form">
                                    <div class="row mb-3">
                                        <div class="col-md-5">
                                            <label class="form-label">Course</label>
                                            <select class="form-select" id="view-course-select" required>
                                                <option value="">Select Course</option>
                                                ${courseOptions}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Semester ID</label>
                                            <input type="text" class="form-control" id="view-semester-id" placeholder="Current semester">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Date (optional)</label>
                                            <input type="date" class="form-control" id="view-attendance-date">
                                        </div>
                                        <div class="col-md-1">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-primary w-100" onclick="loadCourseAttendance()">
                                                Load
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div id="course-attendance-list" class="mt-3"></div>
                    `;
                } catch (error) {
                    UIHelper.showError(error.message, content);
                }
            } else if (role === 'ROLE_SUPERADMIN') {
                try {
                    const courses = await API.getCourses();
                    const courseOptions = courses.map(c => `<option value="${c.id}">${c.code} - ${c.nameEn}</option>`).join('');
                    content.innerHTML = `
                        <div class="card mb-4">
                            <div class="card-header">View Course Attendance</div>
                            <div class="card-body">
                                <form id="attendance-view-form">
                                    <div class="row mb-3">
                                        <div class="col-md-5">
                                            <label class="form-label">Course</label>
                                            <select class="form-select" id="view-course-select" required>
                                                <option value="">Select Course</option>
                                                ${courseOptions}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Semester ID</label>
                                            <input type="text" class="form-control" id="view-semester-id" placeholder="Current semester">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Date (optional)</label>
                                            <input type="date" class="form-control" id="view-attendance-date">
                                        </div>
                                        <div class="col-md-1">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-primary w-100" onclick="loadCourseAttendance()">
                                                Load
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div id="course-attendance-list"></div>
                    `;
                } catch (error) {
                    UIHelper.showError(error.message, content);
                }
            } else {
                content.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-shield-lock me-2"></i>Attendance access is limited to students, professors, and administrators.
                    </div>
                `;
            }
        }
        
        async function loadStudentsForAttendance() {
            const courseSelect = document.getElementById('record-course-select');
            const courseId = courseSelect.value;
            const semesterId = courseSelect.options[courseSelect.selectedIndex]?.dataset.semester || '';
            const sessionDate = document.getElementById('record-session-date').value;
            const sessionType = document.getElementById('record-session-type').value;
            
            if (!courseId || !sessionDate) {
                alert('Please select course and date');
                return;
            }
            
            try {
                const data = await API.getCourseStudents(courseId, semesterId);
                const listDiv = document.getElementById('students-attendance-list');
                
                listDiv.innerHTML = `
                    <div class="card">
                        <div class="card-header">Mark Attendance</div>
                        <div class="card-body">
                            <div id="attendance-message"></div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Student ID</th>
                                            <th>Student Name</th>
                                            <th>Status</th>
                                            <th>Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.students.map(s => `
                                            <tr>
                                                <td>${s.studentId}</td>
                                                <td>${s.studentName}</td>
                                                <td>
                                                    <select class="form-select form-select-sm" id="status-${s.registrationId}">
                                                        <option value="present">Present</option>
                                                        <option value="absent">Absent</option>
                                                        <option value="late">Late</option>
                                                        <option value="excused">Excused</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control form-control-sm" id="remarks-${s.registrationId}" placeholder="Optional">
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <button class="btn btn-success" onclick="saveAttendance()">
                                    <i class="bi bi-save me-2"></i>Save Attendance
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('students-attendance-list'));
            }
        }
        
        async function saveAttendance() {
            const courseSelect = document.getElementById('record-course-select');
            const courseId = courseSelect.value;
            const semesterId = courseSelect.options[courseSelect.selectedIndex]?.dataset.semester || '';
            const sessionDate = document.getElementById('record-session-date').value;
            const sessionType = document.getElementById('record-session-type').value;
            
            const students = [];
            document.querySelectorAll('#students-attendance-list tbody tr').forEach(row => {
                const select = row.querySelector('select');
                const input = row.querySelector('input');
                if (select && input) {
                    const registrationId = select.id.replace('status-', '');
                    students.push({
                        studentId: row.cells[0].textContent,
                        status: select.value,
                        remarks: input.value
                    });
                }
            });
            
            try {
                await API.recordAttendance(courseId, semesterId, sessionDate, sessionType, students);
                UIHelper.showSuccess('Attendance recorded successfully!', document.getElementById('attendance-message'));
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('attendance-message'));
            }
        }

        async function loadCourseAttendance() {
            const courseSelect = document.getElementById('view-course-select');
            const courseId = courseSelect?.value;
            let semesterId = document.getElementById('view-semester-id')?.value.trim();
            const selectedOption = courseSelect?.options[courseSelect.selectedIndex];
            if (!semesterId && selectedOption?.dataset?.semester) {
                semesterId = selectedOption.dataset.semester;
            }
            const date = document.getElementById('view-attendance-date')?.value;

            if (!courseId) {
                alert('Please select a course');
                return;
            }

            try {
                const data = await API.getCourseAttendance(courseId, semesterId, date);
                const attendance = data.attendance || [];
                renderAttendanceRecords(attendance, 'course-attendance-list', role !== 'ROLE_STUDENT');
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('course-attendance-list'));
            }
        }

        async function openAttendanceModal(id, status, notes) {
            if (!attendanceModal) {
                attendanceModal = new bootstrap.Modal(document.getElementById('attendanceModal'));
            }
            document.getElementById('attendance-edit-id').value = id;
            document.getElementById('attendance-edit-status').value = status || 'present';
            document.getElementById('attendance-edit-notes').value = notes || '';
            editMessage.innerHTML = '';
            attendanceModal.show();
        }

        async function updateAttendanceRecord(event) {
            event.preventDefault();
            const attendanceId = parseInt(document.getElementById('attendance-edit-id').value, 10);
            const status = document.getElementById('attendance-edit-status').value;
            const notes = document.getElementById('attendance-edit-notes').value.trim();
            try {
                await API.updateAttendanceRecord({ attendanceId, status, notes });
                UIHelper.showSuccess('Attendance updated.', editMessage);
                await loadCourseAttendance();
                setTimeout(() => attendanceModal.hide(), 600);
            } catch (error) {
                UIHelper.showError(error.message, editMessage);
            }
        }

        async function deleteAttendanceRecord(attendanceId) {
            if (!confirm('Delete this attendance record?')) return;
            try {
                await API.deleteAttendance(attendanceId);
                await loadCourseAttendance();
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('course-attendance-list'));
            }
        }
        
        (async () => {
            const ready = await UIHelper.initializePage();
            if (!ready) return;
            role = auth.getRole();

            editForm.addEventListener('submit', updateAttendanceRecord);
            loadAttendance();
            
            const user = auth.getUser();
            if (user && user.fullName) {
                document.getElementById('user-avatar').textContent = user.fullName.charAt(0).toUpperCase();
            }
        })();
    </script>
</body>
</html>
