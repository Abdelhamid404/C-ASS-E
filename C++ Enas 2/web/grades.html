<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grades - NCTU SIS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h3><i class="bi bi-mortarboard-fill"></i> NCTU SIS</h3>
        </div>
        <ul class="nav flex-column sidebar-menu" id="sidebar-menu"></ul>
        <div class="px-3 py-2">
            <button class="btn btn-outline-danger btn-sm w-100" onclick="auth.logout()">
                <i class="bi bi-box-arrow-right me-2"></i>Logout
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="topbar">
            <h4 class="mb-0">Grades</h4>
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">U</div>
                <div>
                    <div id="user-name">User</div>
                    <small class="text-muted" id="user-role">Role</small>
                </div>
            </div>
        </div>

        <div id="grades-content">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('courseId');
        const semesterId = urlParams.get('semesterId');
        const studentIdParam = urlParams.get('studentId');
        
        async function loadGrades() {
            const role = auth.getRole();
            const content = document.getElementById('grades-content');
            
            if (role === 'ROLE_STUDENT') {
                try {
                    const user = auth.getUser();
                    const grades = await API.getStudentGrades(user.studentId, semesterId || '');
                    // API.getStudentGrades() already returns the grades array
                    
                    if (grades.length === 0) {
                        content.innerHTML = `
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>No grades found.
                            </div>
                        `;
                        return;
                    }
                    
                    content.innerHTML = `
                        <div class="card">
                            <div class="card-header">My Grades</div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Course Code</th>
                                                <th>Course Name</th>
                                                <th>Assignment 1</th>
                                                <th>Assignment 2</th>
                                                <th>Year Work</th>
                                                <th>Midterm</th>
                                                <th>Final Exam</th>
                                                <th>Total</th>
                                                <th>Percentage</th>
                                                <th>GPA</th>
                                                <th>Grade</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${grades.map(g => `
                                                <tr>
                                                    <td>${g.courseCode}</td>
                                                    <td>${g.courseName}</td>
                                                    <td>${Number(g.assignment1 || 0).toFixed(2)}</td>
                                                    <td>${Number(g.assignment2 || 0).toFixed(2)}</td>
                                                    <td>${Number(g.yearWork || 0).toFixed(2)}</td>
                                                    <td>${Number(g.midterm || 0).toFixed(2)}</td>
                                                    <td>${Number(g.finalExam || 0).toFixed(2)}</td>
                                                    <td>${Number(g.totalMarks || 0).toFixed(2)}</td>
                                                    <td>${Number(g.percentage || 0).toFixed(1)}%</td>
                                                    <td>${Number(g.gpa || 0).toFixed(2)}</td>
                                                    <td><span class="badge bg-${UIHelper.getGradeColor(g.letterGrade)}">${g.letterGrade}</span></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    UIHelper.showError(error.message, content);
                }
            } else if ((role === 'ROLE_PROFESSOR' || role === 'ROLE_SUPERADMIN') && courseId) {
                try {
                    const data = await API.getCourseStudents(courseId, semesterId || '');
                    const students = data && data.students ? data.students : [];
                    
                    if (students.length === 0) {
                        content.innerHTML = `
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>No students found for this course.
                            </div>
                        `;
                        return;
                    }
                    
                    content.innerHTML = `
                        <div class="card">
                            <div class="card-header">Grade Entry - Course Students</div>
                            <div class="card-body">
                                <div id="grade-message"></div>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Student ID</th>
                                                <th>Student Name</th>
                                                <th>Assignment 1</th>
                                                <th>Assignment 2</th>
                                                <th>Year Work</th>
                                            <th>Midterm</th>
                                            <th>Final Exam</th>
                                            <th>Total</th>
                                            <th>Grade</th>
                                            <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${students.map(s => `
                                                <tr id="row-${s.registrationId}" data-student-id="${s.studentId}" data-course-id="${s.courseId}" data-semester-id="${s.semesterId}">
                                                    <td>${s.studentId}</td>
                                                    <td>${s.studentName}</td>
                                                    <td><input type="number" class="form-control form-control-sm" id="a1-${s.registrationId}" value="${Number(s.assignment1 || 0).toFixed(2)}" step="0.01"></td>
                                                    <td><input type="number" class="form-control form-control-sm" id="a2-${s.registrationId}" value="${Number(s.assignment2 || 0).toFixed(2)}" step="0.01"></td>
                                                    <td><input type="number" class="form-control form-control-sm" id="yw-${s.registrationId}" value="${Number(s.yearWork || 0).toFixed(2)}" step="0.01"></td>
                                                    <td><input type="number" class="form-control form-control-sm" id="mt-${s.registrationId}" value="${Number(s.midterm || 0).toFixed(2)}" step="0.01"></td>
                                                    <td><input type="number" class="form-control form-control-sm" id="fe-${s.registrationId}" value="${Number(s.finalExam || 0).toFixed(2)}" step="0.01"></td>
                                                    <td id="total-${s.registrationId}">${Number(s.totalMarks || 0).toFixed(2)}</td>
                                                    <td><span class="badge bg-${UIHelper.getGradeColor(s.letterGrade)}" id="grade-${s.registrationId}">${s.letterGrade}</span></td>
                                                    <td>
                                                        <button class="btn btn-primary btn-sm me-1" onclick="saveGrade(${s.registrationId})">
                                                            <i class="bi bi-save"></i> Save
                                                        </button>
                                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteGrade(${s.registrationId})">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    UIHelper.showError(error.message, content);
                }
            } else if (role === 'ROLE_PROFESSOR') {
                try {
                    const data = await API.getProfessorCourses();
                    content.innerHTML = `
                        <div class="card">
                            <div class="card-header">Select a Course</div>
                            <div class="card-body">
                                <div class="row">
                                    ${data.courses.map(c => `
                                        <div class="col-md-4 mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5>${c.courseCode || c.code}</h5>
                                                    <p class="text-muted">${c.courseName || c.nameEn}</p>
                                                    <a href="grades.html?courseId=${c.courseId}&semesterId=${c.semesterId}" class="btn btn-primary btn-sm">
                                                        <i class="bi bi-clipboard-check me-1"></i>Enter Grades
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    UIHelper.showError(error.message, content);
                }
            } else if (role === 'ROLE_SUPERADMIN') {
                if (studentIdParam) {
                    try {
                        const grades = await API.getStudentGrades(studentIdParam, semesterId || '');
                        if (grades.length === 0) {
                            content.innerHTML = `
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>No grades found for this student.
                                </div>
                            `;
                            return;
                        }
                        content.innerHTML = `
                            <div class="card">
                                <div class="card-header">Student Grades - ${studentIdParam}</div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Course Code</th>
                                                    <th>Course Name</th>
                                                    <th>Assignment 1</th>
                                                    <th>Assignment 2</th>
                                                    <th>Year Work</th>
                                                    <th>Midterm</th>
                                                    <th>Final Exam</th>
                                                    <th>Total</th>
                                                    <th>Percentage</th>
                                                    <th>GPA</th>
                                                    <th>Grade</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${grades.map(g => `
                                                    <tr>
                                                        <td>${g.courseCode}</td>
                                                        <td>${g.courseName}</td>
                                                        <td>${Number(g.assignment1 || 0).toFixed(2)}</td>
                                                        <td>${Number(g.assignment2 || 0).toFixed(2)}</td>
                                                        <td>${Number(g.yearWork || 0).toFixed(2)}</td>
                                                        <td>${Number(g.midterm || 0).toFixed(2)}</td>
                                                        <td>${Number(g.finalExam || 0).toFixed(2)}</td>
                                                        <td>${Number(g.totalMarks || 0).toFixed(2)}</td>
                                                        <td>${Number(g.percentage || 0).toFixed(1)}%</td>
                                                        <td>${Number(g.gpa || 0).toFixed(2)}</td>
                                                        <td><span class="badge bg-${UIHelper.getGradeColor(g.letterGrade)}">${g.letterGrade}</span></td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                        return;
                    } catch (error) {
                        UIHelper.showError(error.message, content);
                        return;
                    }
                }

                try {
                    const courses = await API.getCourses();
                    content.innerHTML = `
                        <div class="card">
                            <div class="card-header">Select a Course</div>
                            <div class="card-body">
                                <div class="row">
                                    ${courses.map(c => `
                                        <div class="col-md-4 mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5>${c.code}</h5>
                                                    <p class="text-muted">${c.nameEn}</p>
                                                    <a href="grades.html?courseId=${c.id}" class="btn btn-primary btn-sm">
                                                        <i class="bi bi-clipboard-check me-1"></i>Manage Grades
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    UIHelper.showError(error.message, content);
                }
            } else if (role === 'ROLE_STUDENT_AFFAIRS') {
                content.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-shield-lock me-2"></i>Grades access is limited to students, professors, and administrators.
                    </div>
                `;
            } else {
                if (studentIdParam) {
                    try {
                        const grades = await API.getStudentGrades(studentIdParam, semesterId || '');
                        if (grades.length === 0) {
                            content.innerHTML = `
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>No grades found for this student.
                                </div>
                            `;
                            return;
                        }
                        content.innerHTML = `
                            <div class="card">
                                <div class="card-header">Student Grades - ${studentIdParam}</div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Course Code</th>
                                                    <th>Course Name</th>
                                                    <th>Assignment 1</th>
                                                    <th>Assignment 2</th>
                                                    <th>Year Work</th>
                                                    <th>Final Exam</th>
                                                    <th>Total</th>
                                                    <th>Percentage</th>
                                                    <th>GPA</th>
                                                    <th>Grade</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${grades.map(g => `
                                                    <tr>
                                                        <td>${g.courseCode}</td>
                                                        <td>${g.courseName}</td>
                                                        <td>${Number(g.assignment1 || 0).toFixed(2)}</td>
                                                        <td>${Number(g.assignment2 || 0).toFixed(2)}</td>
                                                        <td>${Number(g.yearWork || 0).toFixed(2)}</td>
                                                        <td>${Number(g.finalExam || 0).toFixed(2)}</td>
                                                        <td>${Number(g.totalMarks || 0).toFixed(2)}</td>
                                                        <td>${Number(g.percentage || 0).toFixed(1)}%</td>
                                                        <td>${Number(g.gpa || 0).toFixed(2)}</td>
                                                        <td><span class="badge bg-${UIHelper.getGradeColor(g.letterGrade)}">${g.letterGrade}</span></td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        UIHelper.showError(error.message, content);
                    }
                } else if (courseId) {
                    try {
                        const grades = await API.getCourseGrades(courseId, semesterId || '');
                        if (grades.length === 0) {
                            content.innerHTML = `
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>No grades found for this course.
                                </div>
                            `;
                            return;
                        }
                        content.innerHTML = `
                            <div class="card">
                                <div class="card-header">Course Grades - ${courseId}</div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Student ID</th>
                                                    <th>Student Name</th>
                                                    <th>Assignment 1</th>
                                                    <th>Assignment 2</th>
                                                    <th>Year Work</th>
                                                    <th>Final Exam</th>
                                                    <th>Total</th>
                                                    <th>Percentage</th>
                                                    <th>GPA</th>
                                                    <th>Grade</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${grades.map(g => `
                                                    <tr>
                                                        <td>${g.studentId}</td>
                                                        <td>${g.studentName}</td>
                                                        <td>${Number(g.assignment1 || 0).toFixed(2)}</td>
                                                        <td>${Number(g.assignment2 || 0).toFixed(2)}</td>
                                                        <td>${Number(g.yearWork || 0).toFixed(2)}</td>
                                                        <td>${Number(g.finalExam || 0).toFixed(2)}</td>
                                                        <td>${Number(g.totalMarks || 0).toFixed(2)}</td>
                                                        <td>${Number(g.percentage || 0).toFixed(1)}%</td>
                                                        <td>${Number(g.gpa || 0).toFixed(2)}</td>
                                                        <td><span class="badge bg-${UIHelper.getGradeColor(g.letterGrade)}">${g.letterGrade}</span></td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        UIHelper.showError(error.message, content);
                    }
                } else {
                    content.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>Select a student or course from the Students or Courses page to view grades.
                        </div>
                    `;
                }
            }
        }
        
        async function saveGrade(registrationId) {
            const a1 = parseFloat(document.getElementById(`a1-${registrationId}`).value) || 0;
            const a2 = parseFloat(document.getElementById(`a2-${registrationId}`).value) || 0;
            const yw = parseFloat(document.getElementById(`yw-${registrationId}`).value) || 0;
            const mt = parseFloat(document.getElementById(`mt-${registrationId}`).value) || 0;
            const fe = parseFloat(document.getElementById(`fe-${registrationId}`).value) || 0;
            
            try {
                const row = document.getElementById(`row-${registrationId}`);
                const studentId = row ? row.dataset.studentId : '';
                const courseId = row ? row.dataset.courseId : '';
                const semesterId = row ? row.dataset.semesterId : '';
                await API.updateGrade({
                    registrationId,
                    studentId,
                    courseId,
                    semesterId,
                    assignment1: a1,
                    assignment2: a2,
                    yearWork: yw,
                    midterm: mt,
                    finalExam: fe
                });
                UIHelper.showSuccess('Grade saved successfully!', document.getElementById('grade-message'));
                
                // Reload to get updated totals
                setTimeout(() => loadGrades(), 1000);
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('grade-message'));
            }
        }

        async function deleteGrade(registrationId) {
            if (!confirm('Delete this grade record?')) return;
            try {
                const row = document.getElementById(`row-${registrationId}`);
                const studentId = row ? row.dataset.studentId : '';
                const courseId = row ? row.dataset.courseId : '';
                const semesterId = row ? row.dataset.semesterId : '';
                await API.deleteGrade({ studentId, courseId, semesterId });
                UIHelper.showSuccess('Grade deleted.', document.getElementById('grade-message'));
                setTimeout(() => loadGrades(), 1000);
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('grade-message'));
            }
        }
        
        (async () => {
            const ready = await UIHelper.initializePage();
            if (!ready) return;

            loadGrades();
            
            const user = auth.getUser();
            if (user && user.fullName) {
                document.getElementById('user-avatar').textContent = user.fullName.charAt(0).toUpperCase();
            }
        })();
    </script>
</body>
</html>
