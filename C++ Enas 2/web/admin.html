<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - NCTU SIS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h3><i class="bi bi-mortarboard-fill"></i> NCTU SIS</h3>
        </div>
        <ul class="nav flex-column sidebar-menu" id="sidebar-menu"></ul>
        <div class="px-3 py-2">
            <button class="btn btn-outline-danger btn-sm w-100" onclick="auth.logout()">
                <i class="bi bi-box-arrow-right me-2"></i>Logout
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="topbar">
            <h4 class="mb-0">Administration</h4>
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">U</div>
                <div>
                    <div id="user-name">User</div>
                    <small class="text-muted" id="user-role">Role</small>
                </div>
            </div>
        </div>

        <div id="admin-content">
            <ul class="nav nav-pills admin-tabs" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-colleges" type="button" role="tab">Colleges</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-departments" type="button" role="tab">Departments</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-levels" type="button" role="tab">Academic Levels</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-semesters" type="button" role="tab">Semesters</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-course-types" type="button" role="tab">Course Types</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-assignments" type="button" role="tab">Assignments</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-registrations" type="button" role="tab">Registrations</button>
                </li>
            </ul>
            <div class="tab-content mt-4">
                <div class="tab-pane fade show active" id="tab-colleges" role="tabpanel">
                    <div id="colleges-section"></div>
                </div>
                <div class="tab-pane fade" id="tab-departments" role="tabpanel">
                    <div id="departments-section"></div>
                </div>
                <div class="tab-pane fade" id="tab-levels" role="tabpanel">
                    <div id="levels-section"></div>
                </div>
                <div class="tab-pane fade" id="tab-semesters" role="tabpanel">
                    <div id="semesters-section"></div>
                </div>
                <div class="tab-pane fade" id="tab-course-types" role="tabpanel">
                    <div id="course-types-section"></div>
                </div>
                <div class="tab-pane fade" id="tab-assignments" role="tabpanel">
                    <div id="assignments-section"></div>
                </div>
                <div class="tab-pane fade" id="tab-registrations" role="tabpanel">
                    <div id="registrations-section"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="collegeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="college-modal-title">Add College</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="college-form">
                    <div class="modal-body">
                        <div id="college-message"></div>
                        <div class="mb-3">
                            <label class="form-label">College ID</label>
                            <input type="text" class="form-control" id="college-id" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Name (English)</label>
                            <input type="text" class="form-control" id="college-name-en" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Name (Arabic)</label>
                            <input type="text" class="form-control" id="college-name-ar">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="college-active" checked>
                            <label class="form-check-label" for="college-active">Active</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="college-save-btn">Save College</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="departmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="department-modal-title">Add Department</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="department-form">
                    <div class="modal-body">
                        <div id="department-message"></div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Department ID</label>
                                <input type="text" class="form-control" id="department-id" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Code</label>
                                <input type="text" class="form-control" id="department-code" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">College</label>
                                <select class="form-select" id="department-college" required></select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Name (English)</label>
                                <input type="text" class="form-control" id="department-name-en" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Name (Arabic)</label>
                                <input type="text" class="form-control" id="department-name-ar">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="department-save-btn">Save Department</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="levelModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="level-modal-title">Add Academic Level</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="level-form">
                    <div class="modal-body">
                        <div id="level-message"></div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Level ID</label>
                                <input type="text" class="form-control" id="level-id" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Year Number</label>
                                <input type="number" class="form-control" id="level-year" min="1" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Name (English)</label>
                                <input type="text" class="form-control" id="level-name-en" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Name (Arabic)</label>
                                <input type="text" class="form-control" id="level-name-ar">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="level-save-btn">Save Level</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="semesterModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="semester-modal-title">Add Semester</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="semester-form">
                    <div class="modal-body">
                        <div id="semester-message"></div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Semester ID</label>
                                <input type="text" class="form-control" id="semester-id" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Academic Year</label>
                                <input type="text" class="form-control" id="semester-year" placeholder="2024/2025" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Semester Number</label>
                                <input type="number" class="form-control" id="semester-number" min="1" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Name (English)</label>
                                <input type="text" class="form-control" id="semester-name-en">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Name (Arabic)</label>
                                <input type="text" class="form-control" id="semester-name-ar">
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="semester-current">
                                <label class="form-check-label" for="semester-current">Current semester</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="semester-save-btn">Save Semester</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="courseTypeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="course-type-title">Add Course Type</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="course-type-form">
                    <div class="modal-body">
                        <div id="course-type-message"></div>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Type ID</label>
                                <input type="text" class="form-control" id="course-type-id" required>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">Type Name</label>
                                <input type="text" class="form-control" id="course-type-name" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Max Marks</label>
                                <input type="number" class="form-control" id="course-type-max" min="0" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Assignment 1</label>
                                <input type="number" class="form-control" id="course-type-a1" min="0">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Assignment 2</label>
                                <input type="number" class="form-control" id="course-type-a2" min="0">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Year Work</label>
                                <input type="number" class="form-control" id="course-type-year" min="0">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Final Exam</label>
                                <input type="number" class="form-control" id="course-type-final" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="course-type-save-btn">Save Course Type</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="assignmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Professor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="assignment-form">
                    <div class="modal-body">
                        <div id="assignment-message"></div>
                        <div class="mb-3">
                            <label class="form-label">Course</label>
                            <select class="form-select" id="assignment-course" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Professor</label>
                            <select class="form-select" id="assignment-professor" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Semester</label>
                            <select class="form-select" id="assignment-semester" required></select>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="assignment-primary" checked>
                            <label class="form-check-label" for="assignment-primary">Primary assignment</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Assign</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="registrationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registration-title">Register Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="registration-form">
                    <div class="modal-body">
                        <div id="registration-message"></div>
                        <input type="hidden" id="registration-id">
                        <div class="mb-3">
                            <label class="form-label">Student</label>
                            <select class="form-select" id="registration-student" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Course</label>
                            <select class="form-select" id="registration-course" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Semester</label>
                            <select class="form-select" id="registration-semester" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="registration-status">
                                <option value="registered">Registered</option>
                                <option value="completed">Completed</option>
                                <option value="dropped">Dropped</option>
                                <option value="withdrawn">Withdrawn</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="registration-save-btn">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script>
        const state = {
            colleges: [],
            departments: [],
            levels: [],
            semesters: [],
            courseTypes: [],
            assignments: [],
            registrations: [],
            courses: [],
            professors: [],
            students: []
        };

        let collegeModal;
        let departmentModal;
        let levelModal;
        let semesterModal;
        let courseTypeModal;
        let assignmentModal;
        let registrationModal;

        let activeCollegeId = null;
        let activeDepartmentId = null;
        let activeLevelId = null;
        let activeSemesterId = null;
        let activeCourseTypeId = null;
        let activeRegistrationId = null;

        function buildOptions(list, selectedId, placeholder, labelKey) {
            const options = [];
            if (placeholder) {
                options.push(`<option value="">${placeholder}</option>`);
            }
            list.forEach(item => {
                const id = item.id || item.courseId || item.professorId || item.studentId || item.semesterId;
                const label = item[labelKey] || item.nameEn || item.name || item.code || item.fullName || item.courseName || id;
                const selected = selectedId && id === selectedId ? 'selected' : '';
                options.push(`<option value="${id}" ${selected}>${label}</option>`);
            });
            return options.join('');
        }

        function formatBadge(value, type = 'secondary') {
            return `<span class="badge bg-${type}">${value}</span>`;
        }

        function renderColleges() {
            const section = document.getElementById('colleges-section');
            section.innerHTML = `
                <div class="page-actions">
                    <div></div>
                    <button class="btn btn-primary" onclick="openCollegeModal('create')">
                        <i class="bi bi-plus-lg me-2"></i>Add College
                    </button>
                </div>
                <div class="card">
                    <div class="card-header">Colleges</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name (EN)</th>
                                        <th>Name (AR)</th>
                                        <th>Status</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${state.colleges.length ? state.colleges.map(c => `
                                        <tr>
                                            <td>${c.id}</td>
                                            <td>${c.nameEn}</td>
                                            <td>${c.nameAr || '-'}</td>
                                            <td>${formatBadge(c.isActive ? 'Active' : 'Inactive', c.isActive ? 'success' : 'secondary')}</td>
                                            <td class="text-end">
                                                <button class="btn btn-sm btn-outline-secondary me-1" onclick="openCollegeModal('edit', '${c.id}')">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCollege('${c.id}')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">No colleges found.</td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDepartments() {
            const section = document.getElementById('departments-section');
            section.innerHTML = `
                <div class="page-actions">
                    <div></div>
                    <button class="btn btn-primary" onclick="openDepartmentModal('create')">
                        <i class="bi bi-plus-lg me-2"></i>Add Department
                    </button>
                </div>
                <div class="card">
                    <div class="card-header">Departments</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Code</th>
                                        <th>Name</th>
                                        <th>College</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${state.departments.length ? state.departments.map(d => {
                                        const college = state.colleges.find(c => c.id === d.collegeId);
                                        return `
                                            <tr>
                                                <td>${d.id}</td>
                                                <td>${d.code}</td>
                                                <td>${d.nameEn}</td>
                                                <td>${college ? college.nameEn : d.collegeId}</td>
                                                <td class="text-end">
                                                    <button class="btn btn-sm btn-outline-secondary me-1" onclick="openDepartmentModal('edit', '${d.id}')">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteDepartment('${d.id}')">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('') : `
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">No departments found.</td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLevels() {
            const section = document.getElementById('levels-section');
            section.innerHTML = `
                <div class="page-actions">
                    <div></div>
                    <button class="btn btn-primary" onclick="openLevelModal('create')">
                        <i class="bi bi-plus-lg me-2"></i>Add Level
                    </button>
                </div>
                <div class="card">
                    <div class="card-header">Academic Levels</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Year</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${state.levels.length ? state.levels.map(l => `
                                        <tr>
                                            <td>${l.id}</td>
                                            <td>${l.nameEn}</td>
                                            <td>${l.yearNumber}</td>
                                            <td class="text-end">
                                                <button class="btn btn-sm btn-outline-secondary me-1" onclick="openLevelModal('edit', '${l.id}')">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteLevel('${l.id}')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="4" class="text-center text-muted py-4">No levels found.</td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSemesters() {
            const section = document.getElementById('semesters-section');
            section.innerHTML = `
                <div class="page-actions">
                    <div></div>
                    <button class="btn btn-primary" onclick="openSemesterModal('create')">
                        <i class="bi bi-plus-lg me-2"></i>Add Semester
                    </button>
                </div>
                <div class="card">
                    <div class="card-header">Semesters</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Academic Year</th>
                                        <th>Number</th>
                                        <th>Current</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${state.semesters.length ? state.semesters.map(s => `
                                        <tr>
                                            <td>${s.id}</td>
                                            <td>${s.nameEn || '-'}</td>
                                            <td>${s.academicYear}</td>
                                            <td>${s.semesterNumber}</td>
                                            <td>${formatBadge(s.isCurrent ? 'Yes' : 'No', s.isCurrent ? 'success' : 'secondary')}</td>
                                            <td class="text-end">
                                                <button class="btn btn-sm btn-outline-secondary me-1" onclick="openSemesterModal('edit', '${s.id}')">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteSemester('${s.id}')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-4">No semesters found.</td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCourseTypes() {
            const section = document.getElementById('course-types-section');
            section.innerHTML = `
                <div class="page-actions">
                    <div></div>
                    <button class="btn btn-primary" onclick="openCourseTypeModal('create')">
                        <i class="bi bi-plus-lg me-2"></i>Add Course Type
                    </button>
                </div>
                <div class="card">
                    <div class="card-header">Course Types</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Max Marks</th>
                                        <th>Assignments</th>
                                        <th>Year Work</th>
                                        <th>Final</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${state.courseTypes.length ? state.courseTypes.map(t => `
                                        <tr>
                                            <td>${t.id}</td>
                                            <td>${t.name}</td>
                                            <td>${t.maxMarks}</td>
                                            <td>${(t.assignment1Max || 0) + (t.assignment2Max || 0)}</td>
                                            <td>${t.yearWorkMax || 0}</td>
                                            <td>${t.finalExamMax || 0}</td>
                                            <td class="text-end">
                                                <button class="btn btn-sm btn-outline-secondary me-1" onclick="openCourseTypeModal('edit', '${t.id}')">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCourseType('${t.id}')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="7" class="text-center text-muted py-4">No course types found.</td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAssignments() {
            const section = document.getElementById('assignments-section');
            section.innerHTML = `
                <div class="page-actions">
                    <div></div>
                    <button class="btn btn-primary" onclick="openAssignmentModal()">
                        <i class="bi bi-plus-lg me-2"></i>Assign Professor
                    </button>
                </div>
                <div class="card">
                    <div class="card-header">Course Assignments</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th>Course</th>
                                        <th>Professor</th>
                                        <th>Semester</th>
                                        <th>Primary</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${state.assignments.length ? state.assignments.map(a => `
                                        <tr>
                                            <td>${a.courseCode} - ${a.courseName}</td>
                                            <td>${a.professorName}</td>
                                            <td>${a.semesterName || a.semesterId}</td>
                                            <td>${formatBadge(a.isPrimary ? 'Yes' : 'No', a.isPrimary ? 'success' : 'secondary')}</td>
                                            <td class="text-end">
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteAssignment(${a.id})">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">No assignments found.</td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRegistrations() {
            const section = document.getElementById('registrations-section');
            section.innerHTML = `
                <div class="page-actions">
                    <div></div>
                    <button class="btn btn-primary" onclick="openRegistrationModal('create')">
                        <i class="bi bi-plus-lg me-2"></i>Register Student
                    </button>
                </div>
                <div class="card">
                    <div class="card-header">Registrations</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Course</th>
                                        <th>Semester</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${state.registrations.length ? state.registrations.map(r => `
                                        <tr>
                                            <td>${r.studentName || r.studentId}</td>
                                            <td>${r.courseCode} - ${r.courseName}</td>
                                            <td>${r.semesterId}</td>
                                            <td>${formatBadge(r.status || 'registered', 'info')}</td>
                                            <td>${r.createdAt ? UIHelper.formatDate(r.createdAt) : '-'}</td>
                                            <td class="text-end">
                                                <button class="btn btn-sm btn-outline-secondary me-1" onclick="openRegistrationModal('edit', ${r.id})">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteRegistration(${r.id})">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-4">No registrations found.</td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        async function openCollegeModal(mode, collegeId = '') {
            if (!collegeModal) {
                collegeModal = new bootstrap.Modal(document.getElementById('collegeModal'));
            }
            const isEdit = mode === 'edit';
            activeCollegeId = isEdit ? collegeId : null;
            const college = isEdit ? state.colleges.find(c => c.id === collegeId) : {};

            document.getElementById('college-modal-title').textContent = isEdit ? 'Edit College' : 'Add College';
            document.getElementById('college-save-btn').textContent = isEdit ? 'Save Changes' : 'Save College';
            document.getElementById('college-id').value = college?.id || '';
            document.getElementById('college-id').readOnly = isEdit;
            document.getElementById('college-name-en').value = college?.nameEn || '';
            document.getElementById('college-name-ar').value = college?.nameAr || '';
            document.getElementById('college-active').checked = college?.isActive ?? true;
            document.getElementById('college-message').innerHTML = '';
            collegeModal.show();
        }

        async function openDepartmentModal(mode, departmentId = '') {
            if (!departmentModal) {
                departmentModal = new bootstrap.Modal(document.getElementById('departmentModal'));
            }
            const isEdit = mode === 'edit';
            activeDepartmentId = isEdit ? departmentId : null;
            const department = isEdit ? state.departments.find(d => d.id === departmentId) : {};

            document.getElementById('department-modal-title').textContent = isEdit ? 'Edit Department' : 'Add Department';
            document.getElementById('department-save-btn').textContent = isEdit ? 'Save Changes' : 'Save Department';
            document.getElementById('department-id').value = department?.id || '';
            document.getElementById('department-id').readOnly = isEdit;
            document.getElementById('department-code').value = department?.code || '';
            document.getElementById('department-name-en').value = department?.nameEn || '';
            document.getElementById('department-name-ar').value = department?.nameAr || '';
            document.getElementById('department-college').innerHTML = buildOptions(state.colleges, department?.collegeId || '', 'Select college', 'nameEn');
            document.getElementById('department-message').innerHTML = '';
            departmentModal.show();
        }

        async function openLevelModal(mode, levelId = '') {
            if (!levelModal) {
                levelModal = new bootstrap.Modal(document.getElementById('levelModal'));
            }
            const isEdit = mode === 'edit';
            activeLevelId = isEdit ? levelId : null;
            const level = isEdit ? state.levels.find(l => l.id === levelId) : {};

            document.getElementById('level-modal-title').textContent = isEdit ? 'Edit Academic Level' : 'Add Academic Level';
            document.getElementById('level-save-btn').textContent = isEdit ? 'Save Changes' : 'Save Level';
            document.getElementById('level-id').value = level?.id || '';
            document.getElementById('level-id').readOnly = isEdit;
            document.getElementById('level-year').value = level?.yearNumber || '';
            document.getElementById('level-name-en').value = level?.nameEn || '';
            document.getElementById('level-name-ar').value = level?.nameAr || '';
            document.getElementById('level-message').innerHTML = '';
            levelModal.show();
        }

        async function openSemesterModal(mode, semesterId = '') {
            if (!semesterModal) {
                semesterModal = new bootstrap.Modal(document.getElementById('semesterModal'));
            }
            const isEdit = mode === 'edit';
            activeSemesterId = isEdit ? semesterId : null;
            const semester = isEdit ? state.semesters.find(s => s.id === semesterId) : {};

            document.getElementById('semester-modal-title').textContent = isEdit ? 'Edit Semester' : 'Add Semester';
            document.getElementById('semester-save-btn').textContent = isEdit ? 'Save Changes' : 'Save Semester';
            document.getElementById('semester-id').value = semester?.id || '';
            document.getElementById('semester-id').readOnly = isEdit;
            document.getElementById('semester-year').value = semester?.academicYear || '';
            document.getElementById('semester-number').value = semester?.semesterNumber || '';
            document.getElementById('semester-name-en').value = semester?.nameEn || '';
            document.getElementById('semester-name-ar').value = semester?.nameAr || '';
            document.getElementById('semester-current').checked = semester?.isCurrent || false;
            document.getElementById('semester-message').innerHTML = '';
            semesterModal.show();
        }

        async function openCourseTypeModal(mode, typeId = '') {
            if (!courseTypeModal) {
                courseTypeModal = new bootstrap.Modal(document.getElementById('courseTypeModal'));
            }
            const isEdit = mode === 'edit';
            activeCourseTypeId = isEdit ? typeId : null;
            const courseType = isEdit ? state.courseTypes.find(t => t.id === typeId) : {};

            document.getElementById('course-type-title').textContent = isEdit ? 'Edit Course Type' : 'Add Course Type';
            document.getElementById('course-type-save-btn').textContent = isEdit ? 'Save Changes' : 'Save Course Type';
            document.getElementById('course-type-id').value = courseType?.id || '';
            document.getElementById('course-type-id').readOnly = isEdit;
            document.getElementById('course-type-name').value = courseType?.name || '';
            document.getElementById('course-type-max').value = courseType?.maxMarks || '';
            document.getElementById('course-type-a1').value = courseType?.assignment1Max || '';
            document.getElementById('course-type-a2').value = courseType?.assignment2Max || '';
            document.getElementById('course-type-year').value = courseType?.yearWorkMax || '';
            document.getElementById('course-type-final').value = courseType?.finalExamMax || '';
            document.getElementById('course-type-message').innerHTML = '';
            courseTypeModal.show();
        }

        async function openAssignmentModal() {
            if (!assignmentModal) {
                assignmentModal = new bootstrap.Modal(document.getElementById('assignmentModal'));
            }
            document.getElementById('assignment-course').innerHTML = buildOptions(state.courses, '', 'Select course', 'nameEn');
            document.getElementById('assignment-professor').innerHTML = buildOptions(state.professors, '', 'Select professor', 'fullName');
            document.getElementById('assignment-semester').innerHTML = buildOptions(state.semesters, '', 'Select semester', 'nameEn');
            document.getElementById('assignment-primary').checked = true;
            document.getElementById('assignment-message').innerHTML = '';
            assignmentModal.show();
        }

        async function openRegistrationModal(mode, registrationId = null) {
            if (!registrationModal) {
                registrationModal = new bootstrap.Modal(document.getElementById('registrationModal'));
            }
            const isEdit = mode === 'edit';
            activeRegistrationId = isEdit ? registrationId : null;
            const registration = isEdit ? state.registrations.find(r => r.id === registrationId) : {};

            document.getElementById('registration-title').textContent = isEdit ? 'Update Registration' : 'Register Student';
            document.getElementById('registration-save-btn').textContent = isEdit ? 'Save Changes' : 'Register';
            document.getElementById('registration-id').value = registration?.id || '';
            document.getElementById('registration-student').innerHTML = buildOptions(state.students, registration?.studentId || '', 'Select student', 'fullName');
            document.getElementById('registration-course').innerHTML = buildOptions(state.courses, registration?.courseId || '', 'Select course', 'nameEn');
            document.getElementById('registration-semester').innerHTML = buildOptions(state.semesters, registration?.semesterId || '', 'Select semester', 'nameEn');
            document.getElementById('registration-status').value = registration?.status || 'registered';
            document.getElementById('registration-message').innerHTML = '';
            registrationModal.show();
        }

        async function submitCollegeForm(event) {
            event.preventDefault();
            const payload = {
                id: document.getElementById('college-id').value.trim(),
                nameEn: document.getElementById('college-name-en').value.trim(),
                nameAr: document.getElementById('college-name-ar').value.trim(),
                isActive: document.getElementById('college-active').checked
            };
            try {
                if (activeCollegeId) {
                    await API.updateCollege(payload);
                } else {
                    await API.createCollege(payload);
                }
                collegeModal.hide();
                await loadAdminData();
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('college-message'));
            }
        }

        async function submitDepartmentForm(event) {
            event.preventDefault();
            const payload = {
                id: document.getElementById('department-id').value.trim(),
                code: document.getElementById('department-code').value.trim(),
                nameEn: document.getElementById('department-name-en').value.trim(),
                nameAr: document.getElementById('department-name-ar').value.trim(),
                collegeId: document.getElementById('department-college').value
            };
            try {
                if (activeDepartmentId) {
                    await API.updateDepartment(payload);
                } else {
                    await API.createDepartment(payload);
                }
                departmentModal.hide();
                await loadAdminData();
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('department-message'));
            }
        }

        async function submitLevelForm(event) {
            event.preventDefault();
            const payload = {
                id: document.getElementById('level-id').value.trim(),
                nameEn: document.getElementById('level-name-en').value.trim(),
                nameAr: document.getElementById('level-name-ar').value.trim(),
                yearNumber: parseInt(document.getElementById('level-year').value, 10) || 0
            };
            try {
                if (activeLevelId) {
                    await API.updateAcademicLevel(payload);
                } else {
                    await API.createAcademicLevel(payload);
                }
                levelModal.hide();
                await loadAdminData();
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('level-message'));
            }
        }

        async function submitSemesterForm(event) {
            event.preventDefault();
            const payload = {
                id: document.getElementById('semester-id').value.trim(),
                nameEn: document.getElementById('semester-name-en').value.trim(),
                nameAr: document.getElementById('semester-name-ar').value.trim(),
                academicYear: document.getElementById('semester-year').value.trim(),
                semesterNumber: parseInt(document.getElementById('semester-number').value, 10) || 0,
                isCurrent: document.getElementById('semester-current').checked
            };
            try {
                if (activeSemesterId) {
                    await API.updateSemester(payload);
                } else {
                    await API.createSemester(payload);
                }
                semesterModal.hide();
                await loadAdminData();
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('semester-message'));
            }
        }

        async function submitCourseTypeForm(event) {
            event.preventDefault();
            const payload = {
                id: document.getElementById('course-type-id').value.trim(),
                name: document.getElementById('course-type-name').value.trim(),
                maxMarks: parseInt(document.getElementById('course-type-max').value, 10) || 0,
                assignment1Max: parseInt(document.getElementById('course-type-a1').value, 10) || 0,
                assignment2Max: parseInt(document.getElementById('course-type-a2').value, 10) || 0,
                yearWorkMax: parseInt(document.getElementById('course-type-year').value, 10) || 0,
                finalExamMax: parseInt(document.getElementById('course-type-final').value, 10) || 0
            };
            try {
                if (activeCourseTypeId) {
                    await API.updateCourseType(payload);
                } else {
                    await API.createCourseType(payload);
                }
                courseTypeModal.hide();
                await loadAdminData();
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('course-type-message'));
            }
        }

        async function submitAssignmentForm(event) {
            event.preventDefault();
            const payload = {
                courseId: document.getElementById('assignment-course').value,
                professorId: document.getElementById('assignment-professor').value,
                semesterId: document.getElementById('assignment-semester').value,
                isPrimary: document.getElementById('assignment-primary').checked
            };
            try {
                await API.createCourseAssignment(payload);
                assignmentModal.hide();
                await loadAdminData();
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('assignment-message'));
            }
        }

        async function submitRegistrationForm(event) {
            event.preventDefault();
            const payload = {
                studentId: document.getElementById('registration-student').value,
                courseId: document.getElementById('registration-course').value,
                semesterId: document.getElementById('registration-semester').value
            };
            try {
                if (activeRegistrationId) {
                    await API.updateRegistration({
                        registrationId: activeRegistrationId,
                        status: document.getElementById('registration-status').value
                    });
                } else {
                    await API.registerStudentToCourse(payload);
                }
                registrationModal.hide();
                await loadAdminData();
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('registration-message'));
            }
        }

        async function deleteCollege(collegeId) {
            if (!confirm('Delete this college?')) return;
            try {
                await API.deleteCollege(collegeId);
                await loadAdminData();
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('colleges-section'));
            }
        }

        async function deleteDepartment(departmentId) {
            if (!confirm('Delete this department?')) return;
            try {
                await API.deleteDepartment(departmentId);
                await loadAdminData();
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('departments-section'));
            }
        }

        async function deleteLevel(levelId) {
            if (!confirm('Delete this academic level?')) return;
            try {
                await API.deleteAcademicLevel(levelId);
                await loadAdminData();
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('levels-section'));
            }
        }

        async function deleteSemester(semesterId) {
            if (!confirm('Delete this semester?')) return;
            try {
                await API.deleteSemester(semesterId);
                await loadAdminData();
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('semesters-section'));
            }
        }

        async function deleteCourseType(typeId) {
            if (!confirm('Delete this course type?')) return;
            try {
                await API.deleteCourseType(typeId);
                await loadAdminData();
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('course-types-section'));
            }
        }

        async function deleteAssignment(assignmentId) {
            if (!confirm('Delete this assignment?')) return;
            try {
                await API.deleteCourseAssignment({ assignmentId });
                await loadAdminData();
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('assignments-section'));
            }
        }

        async function deleteRegistration(registrationId) {
            if (!confirm('Delete this registration?')) return;
            try {
                await API.deleteRegistration(registrationId);
                await loadAdminData();
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('registrations-section'));
            }
        }

        async function loadAdminData() {
            try {
                const [
                    colleges,
                    departments,
                    levels,
                    semesters,
                    courseTypes,
                    assignments,
                    registrations,
                    courses,
                    professors,
                    students
                ] = await Promise.all([
                    API.getColleges(),
                    API.getDepartments(),
                    API.getAcademicLevels(),
                    API.getSemesters(),
                    API.getCourseTypes(),
                    API.getCourseAssignments(),
                    API.getRegistrations(),
                    API.getCourses(),
                    API.getProfessors(),
                    API.getStudents()
                ]);

                state.colleges = colleges;
                state.departments = departments;
                state.levels = levels;
                state.semesters = semesters;
                state.courseTypes = courseTypes;
                state.assignments = assignments;
                state.registrations = registrations;
                state.courses = courses;
                state.professors = professors;
                state.students = students;

                renderColleges();
                renderDepartments();
                renderLevels();
                renderSemesters();
                renderCourseTypes();
                renderAssignments();
                renderRegistrations();
            } catch (error) {
                UIHelper.showError(error.message, document.getElementById('admin-content'));
            }
        }

        document.getElementById('college-form').addEventListener('submit', submitCollegeForm);
        document.getElementById('department-form').addEventListener('submit', submitDepartmentForm);
        document.getElementById('level-form').addEventListener('submit', submitLevelForm);
        document.getElementById('semester-form').addEventListener('submit', submitSemesterForm);
        document.getElementById('course-type-form').addEventListener('submit', submitCourseTypeForm);
        document.getElementById('assignment-form').addEventListener('submit', submitAssignmentForm);
        document.getElementById('registration-form').addEventListener('submit', submitRegistrationForm);

        (async () => {
            const ready = await UIHelper.initializePage();
            if (!ready) return;
            if (!auth.requireRoles(['ROLE_SUPERADMIN'])) {
                return;
            }

            loadAdminData();

            const user = auth.getUser();
            if (user && user.fullName) {
                document.getElementById('user-avatar').textContent = user.fullName.charAt(0).toUpperCase();
            }
        })();
    </script>
</body>
</html>
