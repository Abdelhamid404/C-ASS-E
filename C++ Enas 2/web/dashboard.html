<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - NCTU SIS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h3><i class="bi bi-mortarboard-fill"></i> NCTU SIS</h3>
        </div>
        <ul class="nav flex-column sidebar-menu" id="sidebar-menu">
            <!-- Populated by ui.js -->
        </ul>
        <div class="px-3 py-2">
            <button class="btn btn-outline-danger btn-sm w-100" onclick="auth.logout()">
                <i class="bi bi-box-arrow-right me-2"></i>Logout
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="topbar">
            <h4 class="mb-0">Dashboard</h4>
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">U</div>
                <div>
                    <div id="user-name">User</div>
                    <small class="text-muted" id="user-role">Role</small>
                </div>
            </div>
        </div>

        <div id="dashboard-content">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script>
        async function loadDashboard() {
            const role = auth.getRole();
            const content = document.getElementById('dashboard-content');
            
            if (role === 'ROLE_STUDENT') {
                try {
                    const data = await API.getStudentDashboard();
                    content.innerHTML = `
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-value">${data.gpa.toFixed(2)}</div>
                                    <div class="stats-label">GPA</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-value">${data.registeredCourses}</div>
                                    <div class="stats-label">Registered Courses</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-value">${data.attendanceRate.toFixed(1)}%</div>
                                    <div class="stats-label">Attendance Rate</div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">Recent Grades</div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Course</th>
                                                <th>Total Marks</th>
                                                <th>Percentage</th>
                                                <th>GPA</th>
                                                <th>Grade</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.recentGrades.map(g => `
                                                <tr>
                                                    <td>${g.courseCode} - ${g.courseName}</td>
                                                    <td>${g.totalMarks.toFixed(2)}</td>
                                                    <td>${g.percentage.toFixed(1)}%</td>
                                                    <td>${g.gpa.toFixed(2)}</td>
                                                    <td><span class="badge bg-${UIHelper.getGradeColor(g.letterGrade)}">${g.letterGrade}</span></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    UIHelper.showError(error.message, content);
                }
            } else if (role === 'ROLE_PROFESSOR') {
                try {
                    const data = await API.getProfessorCourses();
                    content.innerHTML = `
                        <div class="card">
                            <div class="card-header">My Assigned Courses</div>
                            <div class="card-body">
                                <div class="row">
                                    ${data.courses.map(c => `
                                        <div class="col-md-4 mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5>${c.courseCode || c.code}</h5>
                                                    <p class="text-muted">${c.courseName || c.nameEn}</p>
                                                    <a href="grades.html?courseId=${c.courseId}&semesterId=${c.semesterId}" class="btn btn-primary btn-sm">
                                                        <i class="bi bi-clipboard-check me-1"></i>Manage Grades
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    UIHelper.showError(error.message, content);
                }
            } else {
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">Welcome, ${auth.getUser().fullName}</div>
                                <div class="card-body">
                                    <p>Use the navigation menu to access different sections of the system.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        (async () => {
            const ready = await UIHelper.initializePage();
            if (!ready) return;

            loadDashboard();
            
            const user = auth.getUser();
            if (user && user.fullName) {
                const avatar = document.getElementById('user-avatar');
                avatar.textContent = user.fullName.charAt(0).toUpperCase();
            }
        })();
    </script>
</body>
</html>

